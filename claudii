#!/bin/bash

set -e

CLAUDII_IMAGE="claudii-dev"
CLAUDII_CONTAINER_PREFIX="claudii-"

GLOBAL_CONFIG_DIR="$HOME/.config/claudii"
DOCKERFILES_DIR="$GLOBAL_CONFIG_DIR/Dockerfiles"

# Build the Docker image
build_image() {
    local ENV_NAME="$1"
    
    # If no environment specified, use default
    if [[ -z "$ENV_NAME" ]]; then
        echo "Building default environment (ubuntu:24.04)..."
        BASE_IMAGE="ubuntu:24.04"
        IMAGE_TAG="$CLAUDII_IMAGE"
    else
        # Check if environment Dockerfile exists
        ENV_DOCKERFILE="$DOCKERFILES_DIR/${ENV_NAME}.Dockerfile"
        if [[ ! -f "$ENV_DOCKERFILE" ]]; then
            echo "Error: Environment '$ENV_NAME' not found at $ENV_DOCKERFILE"
            echo "Available environments:"
            ls -1 "$DOCKERFILES_DIR" 2>/dev/null | grep '\.Dockerfile$' | sed 's/\.Dockerfile$//' | sed 's/^/  - /'
            exit 1
        fi
        
        echo "Building environment: $ENV_NAME"
        
        # Build the environment-specific base image
        USER_IMAGE_TAG="claudii-${ENV_NAME}-base:latest"
        docker build -t "$USER_IMAGE_TAG" -f "$ENV_DOCKERFILE" "$DOCKERFILES_DIR/"
        if [[ $? -ne 0 ]]; then
            echo "Error: Failed to build $ENV_NAME environment"
            exit 1
        fi
        
        BASE_IMAGE="$USER_IMAGE_TAG"
        IMAGE_TAG="claudii-${ENV_NAME}:latest"
    fi
    
    echo "Using base image: $BASE_IMAGE"
    echo "Generating CLAUDE.md..."
    if ! "$GLOBAL_CONFIG_DIR/.claudii/generate-claude-md.sh" "$BASE_IMAGE" > "$GLOBAL_CONFIG_DIR/.claudii/CLAUDE.md" 2>/dev/null; then
        echo "Warning: Could not generate CLAUDE.md (claude CLI not found)"
        # Create a basic CLAUDE.md
        cat > "$GLOBAL_CONFIG_DIR/.claudii/CLAUDE.md" << EOF
# Claudii Development Environment

Base image: $BASE_IMAGE

This environment includes all standard claudii tools:
- Git and GitHub CLI
- Claude Code CLI
- Node.js and npm
- Text editors (vim, neovim)
- JSON processor (jq)

Plus the specific tools from your environment's Dockerfile.
EOF
    fi
    
    echo "Building Docker image: $IMAGE_TAG"
    # Build from global claudii Dockerfile with the determined base image
    docker build --build-arg BASE_IMAGE="$BASE_IMAGE" -t "$IMAGE_TAG" "$GLOBAL_CONFIG_DIR/.claudii/"
    
    echo "Docker image built successfully: $IMAGE_TAG"
}


# Get Claude credentials from macOS keychain
get_claude_credentials() {
    if [[ "$OSTYPE" == "darwin"* ]]; then
        CLAUDE_CREDS=$(security find-generic-password -s "Claude Code-credentials" -w 2>/dev/null || echo "")
        if [[ -n "$CLAUDE_CREDS" ]]; then
            echo "$CLAUDE_CREDS"
        else
            echo "Warning: Claude Code credentials not found in keychain" >&2
            echo ""
        fi
    else
        echo "Warning: Credential extraction only supported on macOS" >&2
        echo ""
    fi
}

# Get git user configuration from host
get_git_config() {
    GIT_USER_NAME=$(git config --global user.name 2>/dev/null || echo "")
    GIT_USER_EMAIL=$(git config --global user.email 2>/dev/null || echo "")
    
    if [[ -z "$GIT_USER_NAME" || -z "$GIT_USER_EMAIL" ]]; then
        echo "Warning: Git user configuration not found on host" >&2
    fi
    
    # Use a simpler format for easier parsing
    echo "${GIT_USER_NAME}|${GIT_USER_EMAIL}"
}

# Get GitHub OAuth token from macOS keychain
get_github_token() {
    if [[ "$OSTYPE" == "darwin"* ]]; then
        GH_TOKEN_B64=$(security find-generic-password -s "gh:github.com" -w 2>/dev/null || echo "")
        if [[ -n "$GH_TOKEN_B64" ]]; then
            # Remove prefix and decode base64
            echo "$GH_TOKEN_B64" | sed 's/go-keyring-base64://' | base64 -d
        else
            echo "Warning: GitHub CLI credentials not found in keychain" >&2
            echo ""
        fi
    else
        echo "Warning: Credential extraction only supported on macOS" >&2
        echo ""
    fi
}

# Select GitHub repository using fzf
select_repo() {
    echo "Fetching your repositories and organizations..." >&2
    
    # Get user repos
    USER_REPOS=$(gh repo list --limit 1000 --json nameWithOwner -q '.[].nameWithOwner' 2>/dev/null || echo "")
    
    # Get list of orgs
    ORGS=$(gh api user/orgs -q '.[].login' 2>/dev/null || echo "")
    
    # Get repos from each org
    ORG_REPOS=""
    for org in $ORGS; do
        if [[ -n "$org" ]]; then
            echo "Fetching repos from $org..." >&2
            ORG_REPO_LIST=$(gh repo list "$org" --limit 1000 --json nameWithOwner -q '.[].nameWithOwner' 2>/dev/null || echo "")
            if [[ -n "$ORG_REPO_LIST" ]]; then
                ORG_REPOS="$ORG_REPOS$ORG_REPO_LIST"$'\n'
            fi
        fi
    done
    
    # Combine all repos
    ALL_REPOS=$(echo -e "$USER_REPOS\n$ORG_REPOS" | grep -v '^$' | sort -u)
    
    if [[ -z "$ALL_REPOS" ]]; then
        echo "Error: No repositories found or gh not authenticated" >&2
        return 1
    fi
    
    SELECTED_REPO=$(echo "$ALL_REPOS" | fzf --prompt="Select repository: " --height=20 --reverse)
    if [[ -z "$SELECTED_REPO" ]]; then
        echo "Error: No repository selected" >&2
        return 1
    fi
    
    echo "$SELECTED_REPO"
}

# Prompt for branch name
get_branch_name() {
    read -p "Enter new branch name: " BRANCH_NAME
    if [[ -z "$BRANCH_NAME" ]]; then
        echo "Error: Branch name cannot be empty" >&2
        return 1
    fi
    echo "$BRANCH_NAME"
}

# Start a new container
start_container() {
    # Parse arguments: [env] repo branch
    local ENV_NAME=""
    local SELECTED_REPO=""
    local BRANCH_NAME=""
    
    # Determine if first arg is environment or repo
    if [[ $# -eq 3 ]]; then
        # claudii start env repo branch
        ENV_NAME="$1"
        SELECTED_REPO="$2"
        BRANCH_NAME="$3"
    elif [[ $# -eq 2 ]]; then
        # claudii start repo branch (use default image)
        SELECTED_REPO="$1"
        BRANCH_NAME="$2"
    elif [[ $# -eq 1 ]]; then
        # Check if it's an environment name
        if [[ -f "$DOCKERFILES_DIR/${1}.Dockerfile" ]]; then
            ENV_NAME="$1"
        else
            SELECTED_REPO="$1"
        fi
    fi
    
    # Determine which image to use
    if [[ -n "$ENV_NAME" ]]; then
        IMAGE_TO_USE="claudii-${ENV_NAME}:latest"
    else
        IMAGE_TO_USE="$CLAUDII_IMAGE"
    fi
    
    # Check if image exists
    if ! docker image inspect "$IMAGE_TO_USE" >/dev/null 2>&1; then
        if [[ -n "$ENV_NAME" ]]; then
            echo "Docker image not found. Please run 'claudii build $ENV_NAME' first."
        else
            echo "Docker image not found. Please run 'claudii build' first."
        fi
        exit 1
    fi
    
    # Generate unique container name
    CONTAINER_NAME="${CLAUDII_CONTAINER_PREFIX}$(date +%s)"
    
    # If no arguments provided, use interactive selection
    if [[ -z "$SELECTED_REPO" ]]; then
        echo "Select a repository to work on:"
        SELECTED_REPO=$(select_repo)
        if [[ $? -ne 0 ]]; then
            echo "Repository selection cancelled"
            return 1
        fi
    fi
    
    if [[ -z "$BRANCH_NAME" ]]; then
        echo "Selected repository: $SELECTED_REPO"
        BRANCH_NAME=$(get_branch_name)
        if [[ $? -ne 0 ]]; then
            echo "Branch creation cancelled"
            return 1
        fi
    fi
    
    echo "Using repository: $SELECTED_REPO"
    echo "Using branch: $BRANCH_NAME"
    
    # Get credentials
    CLAUDE_CREDENTIALS=$(get_claude_credentials)
    GH_TOKEN=$(get_github_token)
    GIT_CONFIG_DATA=$(get_git_config)
    
    echo "Starting container: $CONTAINER_NAME"
    
    # Get GitHub username from hosts.yml if it exists
    GH_USER=$(grep -A2 "github.com:" ~/.config/gh/hosts.yml 2>/dev/null | grep "user:" | cut -d' ' -f6 || echo "")
    
    # Create hosts.yml content
    GH_HOSTS_CONTENT=""
    if [[ -n "$GH_TOKEN" ]]; then
        GH_HOSTS_CONTENT="github.com:
    oauth_token: $GH_TOKEN
    user: ${GH_USER:-unknown}
    git_protocol: https"
    fi
    
    # Run container
    docker run -it --rm --name "$CONTAINER_NAME" \
        -e "CLAUDE_CREDENTIALS=$CLAUDE_CREDENTIALS" \
        -e "GH_HOSTS_CONTENT=$GH_HOSTS_CONTENT" \
        -e "GIT_CONFIG_DATA=$GIT_CONFIG_DATA" \
        "$IMAGE_TO_USE" "$SELECTED_REPO" "$BRANCH_NAME"
    
    echo "Container stopped"
}

# Clean up stopped containers
clean_containers() {
    echo "Cleaning up Claudii containers..."
    
    # Get all containers (running and stopped) with Claudii prefix
    CONTAINERS=$(docker ps -a --filter "name=${CLAUDII_CONTAINER_PREFIX}" --format "{{.Names}}" 2>/dev/null || true)
    
    if [[ -z "$CONTAINERS" ]]; then
        echo "No Claudii containers found"
        return
    fi
    
    # Remove containers
    echo "$CONTAINERS" | xargs docker rm -f 2>/dev/null || true
    echo "Cleaned up containers: $CONTAINERS"
}

# List available environments
list_environments() {
    echo "Available environments:"
    if [[ -d "$DOCKERFILES_DIR" ]]; then
        local envs=$(ls -1 "$DOCKERFILES_DIR" 2>/dev/null | grep '\.Dockerfile$' | sed 's/\.Dockerfile$//')
        if [[ -n "$envs" ]]; then
            echo "$envs" | sed 's/^/  - /'
        else
            echo "  (none - create Dockerfiles in $DOCKERFILES_DIR/)"
        fi
    else
        echo "  (none - run 'claudii build' to set up)"
    fi
    echo ""
    echo "To create a new environment:"
    echo "  1. Create a Dockerfile at $DOCKERFILES_DIR/<name>.Dockerfile"
    echo "  2. Run 'claudii build <name>'"
}

# Uninstall claudii completely
uninstall_claudii() {
    echo "This will uninstall claudii and remove all configuration:"
    echo "  - Remove ~/.config/claudii/"
    echo "  - Remove ~/.local/bin/claudii symlink"
    echo "  - Remove claudii Docker images"
    echo ""
    echo "Note: PATH modifications will NOT be removed as they may affect other tools"
    echo ""
    read -p "Are you sure you want to uninstall? (y/N) " -n 1 -r
    echo
    
    if [[ ! $REPLY =~ ^[Yy]$ ]]; then
        echo "Uninstall cancelled"
        return 0
    fi
    
    echo "Uninstalling claudii..."
    
    # Remove config directory
    if [[ -d "$HOME/.config/claudii" ]]; then
        echo "Removing ~/.config/claudii/..."
        rm -rf "$HOME/.config/claudii"
    fi
    
    # Remove symlink
    if [[ -L "$HOME/.local/bin/claudii" ]]; then
        echo "Removing ~/.local/bin/claudii symlink..."
        rm -f "$HOME/.local/bin/claudii"
    fi
    
    # Remove Docker images
    echo "Removing claudii Docker images..."
    docker images --format "{{.Repository}}:{{.Tag}}" | grep "^claudii" | while read image; do
        echo "Removing $image..."
        docker rmi "$image" 2>/dev/null || true
    done
    
    # Clean up any remaining containers
    clean_containers
    
    echo "Claudii has been uninstalled successfully!"
    echo "Note: The claudii repository itself was not removed."
    echo "Note: ~/.local/bin remains in your PATH for other tools."
}

# Show help
show_help() {
    cat << EOF
Claudii - Claude Code Development Container Helper

Usage: $0 <command> [options]

Commands:
    list                              List available environments
    build [environment]               Build a Docker image
                                      If no environment specified, builds default (ubuntu:24.04)
                                      Example: $0 build rust
    start [environment] repo branch   Start a new development container
                                      Environment is optional, defaults to base image
                                      Example: $0 start rust owner/repo feature-branch
                                      Example: $0 start owner/repo feature-branch
    clean                             Remove all Claudii containers
    uninstall                         Remove claudii from your system
    help                              Show this help message

Environments:
    Store custom Dockerfiles in: $DOCKERFILES_DIR/
    Name them: <environment>.Dockerfile (e.g., rust.Dockerfile, python.Dockerfile)
    
Workflow:
    1. Create environment: $DOCKERFILES_DIR/rust.Dockerfile
    2. Build it: claudii build rust
    3. Use it: claudii start rust owner/repo new-feature

Note: Only Ubuntu-based Docker images are supported.
EOF
}

# Main command handling
case "${1:-}" in
    list)
        list_environments
        ;;
    build)
        shift  # Remove 'build' from arguments
        build_image "$@"
        ;;
    start)
        shift  # Remove 'start' from arguments
        start_container "$@"
        ;;
    clean)
        clean_containers
        ;;
    uninstall)
        uninstall_claudii
        ;;
    help|--help|-h)
        show_help
        ;;
    *)
        echo "Error: Unknown command '${1:-}'"
        echo
        show_help
        exit 1
        ;;
esac